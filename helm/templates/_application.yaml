{{- define "argocd.app" }}
{{- $_ := (dict) }}
{{- /* make a $root variable which has all the root level values plus $root.curApp */}}
{{- $root := .root }}
{{- $curApp := (dict) }}
{{- $_ = merge $curApp .curApp }}
{{- /* merge root values to curApp, retaining curApp value if provided */}}
{{- $_ = merge $curApp (pick $root.Values "project" "repoUrl" "repoBranch" "repoPath" "namespacePrefix" "namePrefix" ) }}
{{- /* use environment for namespace/name prefix if not provided at app or root level */}}
{{- $_ = merge $curApp (set (dict) "namespacePrefix" (get $root.Values.global.clusterInfo "environment") ) }}
{{- $_ = merge $curApp (set (dict) "namePrefix" (get $root.Values.global.clusterInfo "environment") ) }}
{{- /* put clusterName and enviornment into curApp, retaining curApp value if provided */}}
{{- $_ = merge $curApp (pick $root.Values.global.clusterInfo "clusterName" "environment") }}
{{- $_ = set $root "curApp" $curApp }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  {{- if and ($root.curApp.name) ((hasKey $root.curApp "addNamePrefix") | ternary $root.curApp.addNamePrefix true) }}
  name: {{ $root.curApp.namePrefix }}-{{ required "a name must be specified for every app" .curApp.name }}
  {{- else }}
  name: {{ required "a name must be specified for every app" .curApp.name }}
  {{- end }}
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  {{- if hasKey $root.curApp "annotations" | ternary $root.curApp.annotations false }}
  annotations:
    {{- (tpl $root.curApp.annotations $root) | nindent 4 }}
  {{- end }}
  {{- if $root.curApp.labels | default false }}
  labels:
    {{- tpl (toYaml $root.curApp.labels) $root | nindent 4 }}
  {{- end }}
spec:
  destination:
    {{- if and ($root.curApp.namespacePrefix) ((hasKey $root.curApp "addNamespacePrefix") | ternary $root.curApp.addNamespacePrefix true) }}
    namespace: {{ $root.curApp.namespacePrefix }}-{{ required "A namespace must be specified for every app" $root.curApp.namespace }}
    {{- else }}
    namespace: {{ required "A namespace must be specified for every app" $root.curApp.namespace }}
    {{- end }}
    name: {{ required "either app.clusterName or global.clusterInfo.clusterName must be specified" $root.curApp.clusterName }}
  project: {{ $root.curApp.project }}
  {{- if $root.curApp.syncPolicy | default false }}
  syncPolicy:
    {{- (tpl $root.curApp.syncPolicy $root) | nindent 4 }}
  {{- end }}
  {{- if $root.curApp.ignoreDifferences | default false }}
  ignoreDifferences:
    {{- (tpl $root.curApp.ignoreDifferences $root) | nindent 4 }}
  {{- end }}
  source:
    repoURL: {{ tpl (toYaml $root.curApp.repoUrl) $root }}
    path: {{ $root.curApp.repoPath | default $root.curApp.name }}
    targetRevision: {{ $root.curApp.repoBranch}}
    {{- if $root.curApp.plugin | default false }}
    plugin:
      name: {{ $root.curApp.plugin.name }}
      env:
        {{- range $key, $value := $root.curApp.plugin.env }}
        - name: {{ $key }}
          value: {{ tpl $value (dict "Values" $root.Values "Template" $.root.Template) | quote }}
        {{- end }}
    {{- else }}
    helm:
      {{- if $root.curApp.releaseName | default false }}
      releaseName: {{ .curApp.releaseName }}
      {{- end }}
      valueFiles:
        {{- if (hasKey $root.curApp "valuesFiles") }}
        {{- tpl ($root.curApp.valuesFiles) $root | nindent 6 }}
        {{- else }}
        - values.yaml
        {{- if (hasKey $root.curApp "environment") }}
        - values-{{ $root.curApp.environment }}.yaml
        {{- end }}
        {{- end }}
      values: |
        global:
          clusterInfo:
{{toYaml $root.Values.global.clusterInfo | indent 12}}
{{- if hasKey $root.curApp "extraValues" }}
{{(tpl $root.curApp.extraValues $root) | indent 8}}
{{- end }}
    {{- end }}
{{- end }}
